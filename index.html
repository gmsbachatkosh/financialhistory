<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Monthly Tracker - Nepali Calendar</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Nepali Date Converter - Load BEFORE our script -->
    <script src="https://cdn.jsdelivr.net/npm/nepali-date-converter@3.0.3/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1a3a6c, #2c5282);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        header h1::before, header h1::after {
            content: "üá≥üáµ";
            font-size: 1.5em;
        }

        .nepali-date-time-display {
            background: rgba(255, 255, 255, 0.15);
            display: inline-block;
            padding: 15px 30px;
            border-radius: 30px;
            margin-top: 15px;
            font-weight: bold;
            letter-spacing: 1px;
            font-size: 1.2em;
            text-align: center;
            min-width: 300px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .nepali-date-time-display .date {
            display: block;
            font-size: 1.5em;
            margin-bottom: 8px;
            color: #ffd700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .nepali-date-time-display .time {
            display: block;
            font-size: 1.3em;
            opacity: 0.95;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .form-section, .data-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e0e0;
        }

        .form-section h2, .data-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.6em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section h2::before {
            content: "üìù";
        }

        .form-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .form-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        label::before {
            font-size: 1.2em;
        }

        label[for="month"]::before { content: "üìÖ"; }
        label[for="member"]::before { content: "üë•"; }
        label[for="deposit"]::before { content: "üí∞"; }
        label[for="loanInterest"]::before { content: "üìà"; }
        label[for="installment"]::before { content: "üí≥"; }
        label[for="fine"]::before { content: "‚öñÔ∏è"; }
        label[for="loanAmount"]::before { content: "üíµ"; }
        label[for="loanTakenNepaliDate"]::before { content: "üóìÔ∏è"; }
        label[for="loanMaturityNepaliDate"]::before { content: "‚è≥"; }
        label[for="year"]::before { content: "üóìÔ∏è"; }

        select, input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            margin-bottom: 25px;
        }

        .data-table th, .data-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #3498db;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr:nth-child(even) {
            background: #fafafa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #3498db;
            font-size: 1.2em;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .status-message {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
            text-align: center;
            font-weight: 600;
            font-size: 0.95em;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .delete-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .month-heading {
            background: linear-gradient(135deg, #2c3e50, #1a2530);
            color: white;
            padding: 15px 20px;
            margin-top: 25px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .month-heading h3 {
            margin: 0;
            font-size: 1.6em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .year-heading {
            background: linear-gradient(135deg, #8e44ad, #6c3483);
            color: white;
            padding: 15px 20px;
            margin-top: 35px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            font-size: 1.8em;
            font-weight: bold;
        }

        .month-total {
            background: #27ae60;
            color: white;
            font-weight: bold;
        }

        .month-total:hover {
            background: #27ae60 !important;
            color: white !important;
            cursor: default;
        }

        .month-total td {
            border-bottom: none !important;
        }

        .grand-total-section {
            background: linear-gradient(135deg, #f39c12, #d35400);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .grand-total-section h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grand-total-section h3::before {
            content: "üìä";
        }

        .grand-total-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .total-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease;
        }

        .total-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .total-card .label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .total-card .value {
            font-size: 1.6em;
            font-weight: bold;
        }

        .remaining-amount-card {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .loan-amount-card {
            background: linear-gradient(135deg, #8e44ad, #6c3483);
        }

        .add-member-btn {
            background: #27ae60;
            margin-top: 15px;
        }

        .add-member-btn:hover {
            background: #229954;
            box-shadow: 0 3px 8px rgba(39, 174, 96, 0.3);
        }

        .member-management {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e0e0;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .member-management h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.3em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-btn {
            background: #95a5a6;
            width: auto;
            margin-top: 0;
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .toggle-btn:hover {
            background: #7f8c8d;
        }

        .member-list {
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px;
        }

        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 6px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }

        .member-item:last-child {
            margin-bottom: 0;
        }

        .remove-member-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .remove-member-btn:hover {
            background: #c0392b;
        }

        .export-btn {
            background: #f39c12;
            margin-top: 12px;
        }

        .export-btn:hover {
            background: #e67e22;
            box-shadow: 0 3px 8px rgba(243, 156, 18, 0.3);
        }

        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .filter-section h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-section h4::before {
            content: "üîç";
        }

        .filter-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .record-count {
            display: inline-block;
            background: rgba(255, 255, 255, 0.3);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .password-modal.active {
            display: flex;
        }

        .password-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            position: relative;
            border-top: 5px solid #3498db;
        }

        .password-box h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8em;
        }

        .password-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            text-align: center;
        }

        .password-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .password-buttons button {
            width: 50%;
            margin-top: 0;
            padding: 10px;
        }

        .cancel-btn {
            background: #95a5a6;
        }

        .cancel-btn:hover {
            background: #7f8c8d;
        }

        .confirm-btn {
            background: #27ae60;
        }

        .confirm-btn:hover {
            background: #229954;
        }

        .month-total-summary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .month-total-summary h4 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .month-total-summary h4::before {
            content: "üßÆ";
        }

        .month-total-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .month-total-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .month-total-item .label {
            font-size: 0.8em;
            opacity: 0.9;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .month-total-item .value {
            font-size: 1.2em;
            font-weight: bold;
        }

        .toggle-section-btn {
            background: #3498db;
            width: auto;
            margin-bottom: 20px;
            padding: 10px 20px;
            font-size: 1em;
        }

        .toggle-section-btn:hover {
            background: #2980b9;
        }

        .section-hidden {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px dashed #ddd;
            margin-bottom: 20px;
        }

        .section-hidden p {
            color: #666;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-buttons button {
            width: 50%;
            margin-top: 0;
        }

        .view-btn {
            background: #3498db;
        }

        .view-btn:hover {
            background: #2980b9;
        }

        .refresh-btn {
            background: #95a5a6;
            width: auto;
            margin-top: 0;
            padding: 8px 15px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .refresh-btn:hover {
            background: #7f8c8d;
        }

        .loan-entry-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .loan-entry-section h3 {
            color: #8e44ad;
            margin-bottom: 15px;
            font-size: 1.4em;
            border-bottom: 2px solid #8e44ad;
            padding-bottom: 8px;
        }

        .loan-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .loan-table th, .loan-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .loan-table th {
            background: #8e44ad;
            color: white;
            font-weight: 600;
        }

        .loan-table tr:hover {
            background: #f8f9fa;
        }

        .loan-total-section {
            background: linear-gradient(135deg, #8e44ad, #6c3483);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }

        .loan-total-section h4 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loan-total-section h4::before {
            content: "üí∞";
        }

        .loan-total-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .loan-total-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .loan-total-item .label {
            font-size: 0.8em;
            opacity: 0.9;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loan-total-item .value {
            font-size: 1.2em;
            font-weight: bold;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .tab-btn {
            background: #ecf0f1;
            width: auto;
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: #dde4e6;
        }

        .tab-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
            font-weight: bold;
            position: relative;
            top: 1px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .nepali-year-badge {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
            font-size: 0.9em;
        }

        .gregorian-date {
            background: #e3f2fd;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #1565c0;
            font-weight: 500;
        }

        .nepali-date {
            background: #e8f5e9;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #2e7d32;
            font-weight: 500;
            margin-left: 5px;
        }

        .highlight {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: #2c3e50;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        footer {
            text-align: center;
            padding: 20px;
            background: #2c3e50;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
            margin-top: 20px;
        }

        .nepali-date-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nepali-date-input select, .nepali-date-input input {
            margin-bottom: 0;
        }

        .date-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .day-dropdown {
            flex: 1.2 !important;
        }

        @media (max-width: 768px) {
            .tab-buttons {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                padding: 8px 15px;
                font-size: 0.9em;
            }
            
            .grand-total-grid, .month-total-grid, .loan-total-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .nepali-date-time-display {
                padding: 12px 20px;
                min-width: auto;
            }
            
            .nepali-date-time-display .date {
                font-size: 1.2em;
            }
            
            .nepali-date-time-display .time {
                font-size: 1.1em;
            }
            
            .nepali-date-input {
                flex-direction: column;
                align-items: stretch;
            }
            
            .nepali-date-input select {
                width: 100% !important;
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Member Monthly Tracker</h1>
            <div class="nepali-date-time-display" id="currentNepaliDateTime">
                <span class="date">üìÖ Loading Nepali Date...</span>
                <span class="time">üïê --:--:-- --</span>
            </div>
        </header>

        <div class="main-content">
            <!-- Data Entry Form -->
            <div class="form-section" id="formSection">
                <!-- Tab Buttons -->
                <div class="tab-buttons">
                    <button type="button" class="tab-btn active" onclick="switchTab('monthly')">Monthly Entry</button>
                    <button type="button" class="tab-btn" onclick="switchTab('loan')">Loan Entry</button>
                </div>

                <!-- Monthly Entry Tab -->
                <div class="tab-content active" id="monthlyTab">
                    <h2>‚ûï Monthly Entry</h2>
                    <div id="formStatus"></div>
                    
                    <form id="memberForm">
                        <div class="form-group">
                            <label for="year">Nepali Year:</label>
                            <select id="year" required>
                                <option value="">--Select Year--</option>
                                <option value="2079">2079</option>
                                <option value="2080">2080</option>
                                <option value="2081">2081</option>
                                <option value="2082">2082</option>
                                <option value="2083">2083</option>
                                <option value="2084">2084</option>
                                <option value="2085">2085</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="month">Month:</label>
                            <select id="month" required>
                                <option value="">--Select Month--</option>
                                <option value="Baishakh">Baishakh (‡§¨‡•à‡§∂‡§æ‡§ñ)</option>
                                <option value="Jestha">Jestha (‡§ú‡•á‡§†)</option>
                                <option value="Ashadh">Ashadh (‡§Ö‡§∏‡§æ‡§∞)</option>
                                <option value="Shrawan">Shrawan (‡§∏‡§æ‡§â‡§®)</option>
                                <option value="Bhadra">Bhadra (‡§≠‡§¶‡•å)</option>
                                <option value="Ashwin">Ashwin (‡§Ö‡§∏‡•ã‡§ú)</option>
                                <option value="Kartik">Kartik (‡§ï‡§æ‡§∞‡•ç‡§§‡§ø‡§ï)</option>
                                <option value="Mangsir">Mangsir (‡§Æ‡§Ç‡§∏‡§ø‡§∞)</option>
                                <option value="Poush">Poush (‡§™‡•Å‡§∏)</option>
                                <option value="Magh">Magh (‡§Æ‡§æ‡§ò)</option>
                                <option value="Falgun">Falgun (‡§´‡§æ‡§ó‡•Å‡§®)</option>
                                <option value="Chaitra">Chaitra (‡§ö‡•à‡§§)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="member">Member:</label>
                            <select id="member" required>
                                <option value="">--Select Member--</option>
                                <option value="Anil Maharjan">Anil Maharjan</option>
                                <option value="Bindu Maharjan">Bindu Maharjan</option>
                                <option value="Manisha Maharjan">Manisha Maharjan</option>
                                <option value="Rajeep Maharjan">Rajeep Maharjan</option>
                                <option value="Sajina Barahi">Sajina Barahi</option>
                                <option value="Supreme Chitrakar">Supreme Chitrakar</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="deposit">Deposit:</label>
                            <input type="number" id="deposit" placeholder="0.00" step="0.01" value="0">
                        </div>

                        <div class="form-group">
                            <label for="loanInterest">Loan Interest:</label>
                            <input type="number" id="loanInterest" placeholder="0.00" step="0.01" value="0">
                        </div>

                        <div class="form-group">
                            <label for="installment">Installment:</label>
                            <input type="number" id="installment" placeholder="0.00" step="0.01" value="0">
                        </div>

                        <div class="form-group">
                            <label for="fine">Fine:</label>
                            <input type="number" id="fine" placeholder="0.00" step="0.01" value="0">
                        </div>

                        <button type="submit">üíæ Submit Entry</button>
                    </form>
                </div>

                <!-- Loan Entry Tab -->
                <div class="tab-content" id="loanTab">
                    <h2>üí∞ Loan Entry</h2>
                    <div id="loanFormStatus"></div>
                    
                    <form id="loanForm">
                        <div class="form-group">
                            <label for="loanYear">Nepali Year:</label>
                            <select id="loanYear" required>
                                <option value="">--Select Year--</option>
                                <option value="2079">2079</option>
                                <option value="2080">2080</option>
                                <option value="2081">2081</option>
                                <option value="2082">2082</option>
                                <option value="2083">2083</option>
                                <option value="2084">2084</option>
                                <option value="2085">2085</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="loanMonth">Month:</label>
                            <select id="loanMonth" required>
                                <option value="">--Select Month--</option>
                                <option value="Baishakh">Baishakh (‡§¨‡•à‡§∂‡§æ‡§ñ)</option>
                                <option value="Jestha">Jestha (‡§ú‡•á‡§†)</option>
                                <option value="Ashadh">Ashadh (‡§Ö‡§∏‡§æ‡§∞)</option>
                                <option value="Shrawan">Shrawan (‡§∏‡§æ‡§â‡§®)</option>
                                <option value="Bhadra">Bhadra (‡§≠‡§¶‡•å)</option>
                                <option value="Ashwin">Ashwin (‡§Ö‡§∏‡•ã‡§ú)</option>
                                <option value="Kartik">Kartik (‡§ï‡§æ‡§∞‡•ç‡§§‡§ø‡§ï)</option>
                                <option value="Mangsir">Mangsir (‡§Æ‡§Ç‡§∏‡§ø‡§∞)</option>
                                <option value="Poush">Poush (‡§™‡•Å‡§∏)</option>
                                <option value="Magh">Magh (‡§Æ‡§æ‡§ò)</option>
                                <option value="Falgun">Falgun (‡§´‡§æ‡§ó‡•Å‡§®)</option>
                                <option value="Chaitra">Chaitra (‡§ö‡•à‡§§)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="loanMember">Member:</label>
                            <select id="loanMember" required>
                                <option value="">--Select Member--</option>
                                <option value="Anil Maharjan">Anil Maharjan</option>
                                <option value="Bindu Maharjan">Bindu Maharjan</option>
                                <option value="Manisha Maharjan">Manisha Maharjan</option>
                                <option value="Rajeep Maharjan">Rajeep Maharjan</option>
                                <option value="Sajina Barahi">Sajina Barahi</option>
                                <option value="Supreme Chitrakar">Supreme Chitrakar</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="loanAmount">Loan Amount:</label>
                            <input type="number" id="loanAmount" placeholder="0.00" step="0.01" required>
                        </div>

                        <div class="form-group">
                            <label for="loanTakenNepaliDate">Loan Taken Date (Nepali):</label>
                            <div class="nepali-date-input">
                                <select id="loanTakenYear" style="flex: 2;" required>
                                    <option value="">Year</option>
                                    <option value="2079">2079</option>
                                    <option value="2080">2080</option>
                                    <option value="2081">2081</option>
                                    <option value="2082">2082</option>
                                    <option value="2083">2083</option>
                                    <option value="2084">2084</option>
                                    <option value="2085">2085</option>
                                </select>
                                <select id="loanTakenMonth" style="flex: 2.5;" required>
                                    <option value="">Month</option>
                                    <option value="1">Baishakh</option>
                                    <option value="2">Jestha</option>
                                    <option value="3">Ashadh</option>
                                    <option value="4">Shrawan</option>
                                    <option value="5">Bhadra</option>
                                    <option value="6">Ashwin</option>
                                    <option value="7">Kartik</option>
                                    <option value="8">Mangsir</option>
                                    <option value="9">Poush</option>
                                    <option value="10">Magh</option>
                                    <option value="11">Falgun</option>
                                    <option value="12">Chaitra</option>
                                </select>
                                <select id="loanTakenDay" class="day-dropdown" required>
                                    <option value="">Day</option>
                                </select>
                            </div>
                            <div class="date-label" id="loanTakenGregorianDate"></div>
                        </div>

                        <div class="form-group">
                            <label for="loanMaturityNepaliDate">Loan Maturity Date (Nepali):</label>
                            <div class="nepali-date-input">
                                <select id="loanMaturityYear" style="flex: 2;" required>
                                    <option value="">Year</option>
                                    <option value="2079">2079</option>
                                    <option value="2080">2080</option>
                                    <option value="2081">2081</option>
                                    <option value="2082">2082</option>
                                    <option value="2083">2083</option>
                                    <option value="2084">2084</option>
                                    <option value="2085">2085</option>
                                </select>
                                <select id="loanMaturityMonth" style="flex: 2.5;" required>
                                    <option value="">Month</option>
                                    <option value="1">Baishakh</option>
                                    <option value="2">Jestha</option>
                                    <option value="3">Ashadh</option>
                                    <option value="4">Shrawan</option>
                                    <option value="5">Bhadra</option>
                                    <option value="6">Ashwin</option>
                                    <option value="7">Kartik</option>
                                    <option value="8">Mangsir</option>
                                    <option value="9">Poush</option>
                                    <option value="10">Magh</option>
                                    <option value="11">Falgun</option>
                                    <option value="12">Chaitra</option>
                                </select>
                                <select id="loanMaturityDay" class="day-dropdown" required>
                                    <option value="">Day</option>
                                </select>
                            </div>
                            <div class="date-label" id="loanMaturityGregorianDate"></div>
                        </div>

                        <button type="submit">üíæ Submit Loan Entry</button>
                    </form>
                </div>

                <!-- Toggle Member Management Button -->
                <button type="button" class="toggle-btn" onclick="toggleMemberManagement()">
                    üë• Toggle Member Management
                </button>

                <!-- Member Management Section (Initially Hidden) -->
                <div class="member-management" id="memberManagementSection">
                    <h3>
                        <span>Member Management</span>
                        <button type="button" class="toggle-btn" onclick="toggleMemberManagement()" style="padding: 4px 10px; font-size: 0.8em;">
                            ‚úï Close
                        </button>
                    </h3>
                    <div class="form-group">
                        <input type="text" id="newMemberName" placeholder="Enter new member name" />
                    </div>
                    <button type="button" class="add-member-btn" onclick="addNewMember()">‚ûï Add Member</button>
                    
                    <div class="member-list" id="memberList">
                        <!-- Members will be displayed here -->
                    </div>
                </div>

                <!-- Export Button -->
                <button type="button" class="export-btn" onclick="exportToCSV()">üì• Export to CSV</button>

                <!-- Hide Form Button -->
                <button type="button" class="toggle-btn" onclick="hideFormSection()" style="background: #e74c3c;">
                    ‚ùå Hide Entry Form
                </button>
            </div>

            <!-- Hidden Form Section Message -->
            <div class="section-hidden" id="formHiddenSection">
                <p><strong>üìù Entry Form Section</strong> is currently hidden</p>
                <button type="button" class="toggle-section-btn" onclick="showPasswordModalForForm()">
                    üëÅÔ∏è Show Entry Form
                </button>
            </div>

            <!-- Data Display Section -->
            <div class="data-section">
                <h2>üìã Monthly Records</h2>
                
                <button type="button" class="refresh-btn" onclick="fetchData()">
                    <span>üîÑ</span> Refresh Data
                </button>
                
                <div class="filter-section">
                    <h4>FilterWhere</h4>
                    <div class="filter-controls">
                        <select id="filterYear" onchange="fetchData()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">All Years</option>
                            <option value="2079">2079</option>
                            <option value="2080">2080</option>
                            <option value="2081">2081</option>
                            <option value="2082">2082</option>
                            <option value="2083">2083</option>
                            <option value="2084">2084</option>
                            <option value="2085">2085</option>
                        </select>
                        <select id="filterMonth" onchange="fetchData()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">All Months</option>
                            <option value="Baishakh">Baishakh</option>
                            <option value="Jestha">Jestha</option>
                            <option value="Ashadh">Ashadh</option>
                            <option value="Shrawan">Shrawan</option>
                            <option value="Bhadra">Bhadra</option>
                            <option value="Ashwin">Ashwin</option>
                            <option value="Kartik">Kartik</option>
                            <option value="Mangsir">Mangsir</option>
                            <option value="Poush">Poush</option>
                            <option value="Magh">Magh</option>
                            <option value="Falgun">Falgun</option>
                            <option value="Chaitra">Chaitra</option>
                        </select>
                    </div>
                    <div class="filter-controls" style="margin-top: 10px;">
                        <select id="filterMember" onchange="fetchData()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">All Members</option>
                            <option value="Anil Maharjan">Anil Maharjan</option>
                            <option value="Bindu Maharjan">Bindu Maharjan</option>
                            <option value="Manisha Maharjan">Manisha Maharjan</option>
                            <option value="Rajeep Maharjan">Rajeep Maharjan</option>
                            <option value="Sajina Barahi">Sajina Barahi</option>
                            <option value="Supreme Chitrakar">Supreme Chitrakar</option>
                        </select>
                    </div>
                </div>
                
                <div id="dataStatus"></div>
                <div id="dataContainer">
                    <div class="loading">Loading data...</div>
                </div>

                <!-- Loan Records Section -->
                <div id="loanDataContainer" style="margin-top: 30px;">
                    <h2 style="color: #8e44ad; margin-bottom: 20px; border-bottom: 2px solid #8e44ad; padding-bottom: 8px;">üí∞ Loan Records</h2>
                    <div class="loading">Loading loan data...</div>
                </div>
            </div>
        </div>

        <footer>
            <p>Member Monthly Tracker &copy; 2026 | Nepal Financial System</p>
        </footer>
    </div>

    <!-- Password Modal -->
    <div class="password-modal" id="passwordModal">
        <div class="password-box">
            <h3>üîí Enter Password</h3>
            <p id="passwordMessage" style="text-align: center; color: #666; margin-bottom: 15px; font-size: 0.9em;">
                Please enter the password to access this section
            </p>
            <input type="password" id="passwordInput" class="password-input" placeholder="Enter password" 
                   onkeypress="if(event.key === 'Enter') verifyPassword()">
            <div class="password-buttons">
                <button type="button" class="cancel-btn" onclick="closePasswordModal()">Cancel</button>
                <button type="button" class="confirm-btn" onclick="verifyPassword()">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCHgrUuln0hRyEVYzCo3DHjLq-ApcseTeI",
            authDomain: "member-tracker-78f9f.firebaseapp.com",
            projectId: "member-tracker-78f9f",
            storageBucket: "member-tracker-78f9f.firebasestorage.app",
            messagingSenderId: "368007807825",
            appId: "1:368007807825:web:e80570af3567c4ed3a0970"
        };

        // Passwords (Change these to your desired passwords)
        const DELETE_PASSWORD = "admin123";      // For deleting entries
        const FORM_ACCESS_PASSWORD = "admin123"; // For accessing the form section

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let entryToDelete = null;
        let actionType = null; // 'delete' or 'show_form'
        let nepaliDateConverter = null;

        // Initialize Nepali date converter
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Nepali date converter
            try {
                nepaliDateConverter = window.nepaliDateConverter;
                console.log('Nepali Date Converter initialized successfully');
                
                // Display current Nepali date and time
                displayCurrentNepaliDateTime();
                
                // Initialize day dropdowns
                initDayDropdowns();
                
                // Set up event listeners
                setupEventListeners();
                
                // Fetch data
                fetchData();
                
                // Form section is hidden by default
                document.getElementById('formHiddenSection').style.display = 'block';
            } catch (error) {
                console.error('Error initializing Nepali Date Converter:', error);
                document.getElementById('currentNepaliDateTime').innerHTML = `
                    <span class="date">‚ö†Ô∏è Date Error</span>
                    <span class="time">Library not loaded. Please refresh.</span>
                `;
            }
        });

        // Initialize day dropdowns
        function initDayDropdowns() {
            // Initialize with default values (2080, Baishakh)
            populateDays('loanTakenDay', '2080', '1');
            populateDays('loanMaturityDay', '2080', '1');
        }

        // Set up event listeners for date inputs
        function setupEventListeners() {
            // Loan Taken Date listeners
            document.getElementById('loanTakenYear').addEventListener('change', function() {
                const year = this.value;
                const month = document.getElementById('loanTakenMonth').value;
                if (year && month) {
                    populateDays('loanTakenDay', year, month);
                }
                updateGregorianDateDisplay();
            });

            document.getElementById('loanTakenMonth').addEventListener('change', function() {
                const year = document.getElementById('loanTakenYear').value;
                const month = this.value;
                if (year && month) {
                    populateDays('loanTakenDay', year, month);
                }
                updateGregorianDateDisplay();
            });

            document.getElementById('loanTakenDay').addEventListener('change', updateGregorianDateDisplay);

            // Loan Maturity Date listeners
            document.getElementById('loanMaturityYear').addEventListener('change', function() {
                const year = this.value;
                const month = document.getElementById('loanMaturityMonth').value;
                if (year && month) {
                    populateDays('loanMaturityDay', year, month);
                }
                updateGregorianDateDisplay();
            });

            document.getElementById('loanMaturityMonth').addEventListener('change', function() {
                const year = document.getElementById('loanMaturityYear').value;
                const month = this.value;
                if (year && month) {
                    populateDays('loanMaturityDay', year, month);
                }
                updateGregorianDateDisplay();
            });

            document.getElementById('loanMaturityDay').addEventListener('change', updateGregorianDateDisplay);
        }

        // Populate day dropdown based on Nepali year and month
        function populateDays(selectId, year, month) {
            const daySelect = document.getElementById(selectId);
            if (!daySelect) {
                console.error(`Day select element not found: ${selectId}`);
                return;
            }
            
            // Clear existing options except the placeholder
            daySelect.innerHTML = '<option value="">Day</option>';
            
            if (!year || !month || !nepaliDateConverter) {
                console.warn('Year, month, or converter not available');
                return;
            }
            
            try {
                // Get number of days in the Nepali month
                // Note: getNepaliMonthDays expects Nepali year and month (1-12)
                const daysInMonth = nepaliDateConverter.getNepaliMonthDays(parseInt(year), parseInt(month));
                
                // Populate day options
                for (let i = 1; i <= daysInMonth; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    daySelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error populating days:', error);
                // Fallback: show 1-32 days
                for (let i = 1; i <= 32; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    daySelect.appendChild(option);
                }
            }
        }

        // Update Gregorian date display when Nepali date changes
        function updateGregorianDateDisplay() {
            if (!nepaliDateConverter) return;
            
            try {
                // Loan Taken Date
                const takenYear = document.getElementById('loanTakenYear').value;
                const takenMonth = document.getElementById('loanTakenMonth').value;
                const takenDay = document.getElementById('loanTakenDay').value;
                
                if (takenYear && takenMonth && takenDay) {
                    const gregorianDate = nepaliDateConverter.nepaliToGregorian(
                        parseInt(takenYear),
                        parseInt(takenMonth),
                        parseInt(takenDay)
                    );
                    
                    const gregorianDateObj = new Date(gregorianDate.year, gregorianDate.month - 1, gregorianDate.day);
                    document.getElementById('loanTakenGregorianDate').textContent = 
                        `Gregorian: ${gregorianDateObj.toLocaleDateString('en-GB')}`;
                } else {
                    document.getElementById('loanTakenGregorianDate').textContent = '';
                }
                
                // Loan Maturity Date
                const maturityYear = document.getElementById('loanMaturityYear').value;
                const maturityMonth = document.getElementById('loanMaturityMonth').value;
                const maturityDay = document.getElementById('loanMaturityDay').value;
                
                if (maturityYear && maturityMonth && maturityDay) {
                    const gregorianDate = nepaliDateConverter.nepaliToGregorian(
                        parseInt(maturityYear),
                        parseInt(maturityMonth),
                        parseInt(maturityDay)
                    );
                    
                    const gregorianDateObj = new Date(gregorianDate.year, gregorianDate.month - 1, gregorianDate.day);
                    document.getElementById('loanMaturityGregorianDate').textContent = 
                        `Gregorian: ${gregorianDateObj.toLocaleDateString('en-GB')}`;
                } else {
                    document.getElementById('loanMaturityGregorianDate').textContent = '';
                }
            } catch (error) {
                console.error('Error converting date:', error);
            }
        }

        // Display current Nepali date and time with live updates
        function displayCurrentNepaliDateTime() {
            if (!nepaliDateConverter) {
                setTimeout(displayCurrentNepaliDateTime, 500);
                return;
            }
            
            try {
                const now = new Date();
                const nepaliDate = nepaliDateConverter.gregorianToNepali(
                    now.getFullYear(),
                    now.getMonth() + 1,  // JavaScript months are 0-indexed
                    now.getDate()
                );
                
                const nepaliMonths = [
                    'Baishakh', 'Jestha', 'Ashadh', 'Shrawan', 'Bhadra', 'Ashwin',
                    'Kartik', 'Mangsir', 'Poush', 'Magh', 'Falgun', 'Chaitra'
                ];
                
                // Validate conversion result
                if (!nepaliDate || !nepaliDate.year || !nepaliDate.month || !nepaliDate.day) {
                    throw new Error('Invalid date conversion result');
                }
                
                // Format Nepali date
                const nepaliMonthName = nepaliMonths[nepaliDate.month - 1] || 'Unknown';
                const formattedDate = `${nepaliMonthName} ${nepaliDate.day}, ${nepaliDate.year}`;
                
                // Format time with AM/PM
                const hours = now.getHours();
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                const formattedTime = `${displayHours}:${minutes}:${seconds} ${ampm}`;
                
                // Update DOM
                document.getElementById('currentNepaliDateTime').innerHTML = `
                    <span class="date">üìÖ ${formattedDate}</span>
                    <span class="time">üïê ${formattedTime}</span>
                `;
                
                // Update time every second
                setTimeout(displayCurrentNepaliDateTime, 1000);
                
            } catch (error) {
                console.error('Error displaying Nepali date/time:', error);
                document.getElementById('currentNepaliDateTime').innerHTML = `
                    <span class="date">‚ö†Ô∏è Date Error</span>
                    <span class="time">${error.message}</span>
                `;
                // Retry after 2 seconds
                setTimeout(displayCurrentNepaliDateTime, 2000);
            }
        }

        // Tab switching function
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Monthly Entry Form submission handler
        document.getElementById('memberForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const statusDiv = document.getElementById('formStatus');
            
            try {
                // Get form values
                const year = document.getElementById('year').value;
                const month = document.getElementById('month').value;
                const member = document.getElementById('member').value;
                const deposit = parseFloat(document.getElementById('deposit').value) || 0;
                const loanInterest = parseFloat(document.getElementById('loanInterest').value) || 0;
                const installment = parseFloat(document.getElementById('installment').value) || 0;
                const fine = parseFloat(document.getElementById('fine').value) || 0;

                // Create data object
                const entryData = {
                    year: year,
                    month: month,
                    member: member,
                    deposit: deposit,
                    loanInterest: loanInterest,
                    installment: installment,
                    fine: fine,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'monthly'
                };

                // Add to Firestore
                await db.collection('memberMonthlyTracker').add(entryData);

                // Show success message
                statusDiv.innerHTML = '<div class="status-message success">‚úÖ Monthly entry added successfully!</div>';
                
                // Reset form
                document.getElementById('memberForm').reset();
                document.getElementById('deposit').value = '0';
                document.getElementById('loanInterest').value = '0';
                document.getElementById('installment').value = '0';
                document.getElementById('fine').value = '0';
                
                // Refresh data display
                fetchData();
                
                // Clear success message after 3 seconds
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                console.error('Error adding document: ', error);
                statusDiv.innerHTML = `<div class="status-message error">‚ùå Error: ${error.message}</div>`;
            }
        });

        // Loan Entry Form submission handler
        document.getElementById('loanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const statusDiv = document.getElementById('loanFormStatus');
            
            try {
                // Get form values
                const year = document.getElementById('loanYear').value;
                const month = document.getElementById('loanMonth').value;
                const member = document.getElementById('loanMember').value;
                const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
                
                // Get Nepali dates
                const loanTakenYear = document.getElementById('loanTakenYear').value;
                const loanTakenMonth = document.getElementById('loanTakenMonth').value;
                const loanTakenDay = document.getElementById('loanTakenDay').value;
                
                const loanMaturityYear = document.getElementById('loanMaturityYear').value;
                const loanMaturityMonth = document.getElementById('loanMaturityMonth').value;
                const loanMaturityDay = document.getElementById('loanMaturityDay').value;

                // Validate dates
                if (!loanTakenYear || !loanTakenMonth || !loanTakenDay) {
                    throw new Error('Please select a complete Loan Taken Date');
                }
                if (!loanMaturityYear || !loanMaturityMonth || !loanMaturityDay) {
                    throw new Error('Please select a complete Loan Maturity Date');
                }

                // Convert Nepali dates to Gregorian for storage
                const takenGregorian = nepaliDateConverter.nepaliToGregorian(
                    parseInt(loanTakenYear),
                    parseInt(loanTakenMonth),
                    parseInt(loanTakenDay)
                );
                
                const maturityGregorian = nepaliDateConverter.nepaliToGregorian(
                    parseInt(loanMaturityYear),
                    parseInt(loanMaturityMonth),
                    parseInt(loanMaturityDay)
                );

                // Format Gregorian dates as YYYY-MM-DD
                const loanTakenDate = `${takenGregorian.year}-${String(takenGregorian.month).padStart(2, '0')}-${String(takenGregorian.day).padStart(2, '0')}`;
                const loanMaturityDate = `${maturityGregorian.year}-${String(maturityGregorian.month).padStart(2, '0')}-${String(maturityGregorian.day).padStart(2, '0')}`;

                // Create data object
                const loanData = {
                    year: year,
                    month: month,
                    member: member,
                    loanAmount: loanAmount,
                    loanTakenDate: loanTakenDate,
                    loanMaturityDate: loanMaturityDate,
                    loanTakenNepaliDate: `${loanTakenYear}-${loanTakenMonth}-${loanTakenDay}`,
                    loanMaturityNepaliDate: `${loanMaturityYear}-${loanMaturityMonth}-${loanMaturityDay}`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'loan'
                };

                // Add to Firestore
                await db.collection('memberMonthlyTracker').add(loanData);

                // Show success message
                statusDiv.innerHTML = '<div class="status-message success">‚úÖ Loan entry added successfully!</div>';
                
                // Reset form
                document.getElementById('loanForm').reset();
                document.getElementById('loanTakenGregorianDate').textContent = '';
                document.getElementById('loanMaturityGregorianDate').textContent = '';
                
                // Re-initialize day dropdowns
                populateDays('loanTakenDay', '2080', '1');
                populateDays('loanMaturityDay', '2080', '1');
                
                // Refresh data display
                fetchData();
                
                // Clear success message after 3 seconds
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                console.error('Error adding loan document: ', error);
                statusDiv.innerHTML = `<div class="status-message error">‚ùå Error: ${error.message}</div>`;
            }
        });

        // Fetch and display data grouped by month
        async function fetchData() {
            const dataContainer = document.getElementById('dataContainer');
            const loanDataContainer = document.getElementById('loanDataContainer');
            const statusDiv = document.getElementById('dataStatus');
            const filterYear = document.getElementById('filterYear').value;
            const filterMonth = document.getElementById('filterMonth').value;
            const filterMember = document.getElementById('filterMember').value;
            
            try {
                // Show loading state
                dataContainer.innerHTML = '<div class="loading">Loading monthly data...</div>';
                loanDataContainer.innerHTML = '<div class="loading">Loading loan data...</div>';
                
                // Build query WITHOUT orderBy to avoid index requirement
                let query = db.collection('memberMonthlyTracker');
                
                if (filterYear) {
                    query = query.where('year', '==', filterYear);
                }
                
                if (filterMonth) {
                    query = query.where('month', '==', filterMonth);
                }
                
                if (filterMember) {
                    query = query.where('member', '==', filterMember);
                }
                
                // Fetch data from Firestore
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    dataContainer.innerHTML = '<div class="empty-state">üì≠ No monthly entries found.</div>';
                    loanDataContainer.innerHTML = '<div class="empty-state">üì≠ No loan entries found.</div>';
                    return;
                }
                
                // Separate monthly and loan entries
                const monthlyEntries = [];
                const loanEntries = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const entry = {
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date()
                    };
                    
                    if (data.type === 'loan') {
                        loanEntries.push(entry);
                    } else {
                        monthlyEntries.push(entry);
                    }
                });
                
                // Sort by timestamp descending (newest first)
                monthlyEntries.sort((a, b) => b.timestamp - a.timestamp);
                loanEntries.sort((a, b) => b.timestamp - a.timestamp);
                
                // Display monthly data
                displayMonthlyData(monthlyEntries, loanEntries);
                
                // Display loan data
                displayLoanData(loanEntries);
                
            } catch (error) {
                console.error('Error fetching data: ', error);
                statusDiv.innerHTML = `<div class="status-message error">‚ùå Error loading data: ${error.message}</div>`;
                dataContainer.innerHTML = '<div class="empty-state">Failed to load data. Please try again.</div>';
                loanDataContainer.innerHTML = '<div class="empty-state">Failed to load loan data.</div>';
            }
        }

        // Display monthly data grouped by year and month
        function displayMonthlyData(monthlyEntries, loanEntries) {
            const dataContainer = document.getElementById('dataContainer');
            
            // Group data by year
            const dataByYear = {};
            const allYears = ['2085', '2084', '2083', '2082', '2081', '2080', '2079'];
            const allMonths = [
                'Baishakh', 'Jestha', 'Ashadh', 'Shrawan', 'Bhadra', 'Ashwin',
                'Kartik', 'Mangsir', 'Poush', 'Magh', 'Falgun', 'Chaitra'
            ];
            
            // Initialize years
            allYears.forEach(year => {
                dataByYear[year] = {};
                allMonths.forEach(month => {
                    dataByYear[year][month] = [];
                });
            });
            
            // Populate data
            monthlyEntries.forEach(entry => {
                if (dataByYear[entry.year] && dataByYear[entry.year][entry.month]) {
                    dataByYear[entry.year][entry.month].push(entry);
                }
            });
            
            // Build HTML with year and month groupings
            let htmlContent = '';
            let grandTotalDeposit = 0;
            let grandTotalLoanInterest = 0;
            let grandTotalInstallment = 0;
            let grandTotalFine = 0;
            let grandTotalRecords = 0;
            
            // Display years in descending order
            allYears.forEach(year => {
                let yearHasData = false;
                let yearTotalDeposit = 0;
                let yearTotalLoanInterest = 0;
                let yearTotalInstallment = 0;
                let yearTotalFine = 0;
                
                // Check if year has any data and calculate year totals
                allMonths.forEach(month => {
                    if (dataByYear[year][month].length > 0) {
                        yearHasData = true;
                        dataByYear[year][month].forEach(entry => {
                            yearTotalDeposit += entry.deposit;
                            yearTotalLoanInterest += entry.loanInterest;
                            yearTotalInstallment += entry.installment;
                            yearTotalFine += entry.fine;
                        });
                    }
                });
                
                if (yearHasData) {
                    // Year heading
                    htmlContent += `
                        <div class="year-heading">
                            <span>Year: ${year}</span><span class="nepali-year-badge">‡§µ‡§ø.‡§∏‡§Ç. ${year}</span>
                        </div>
                    `;
                    
                    // Display months in chronological order
                    allMonths.forEach(monthName => {
                        if (dataByYear[year][monthName].length > 0) {
                            const monthData = dataByYear[year][monthName];
                            
                            // Calculate month totals
                            let monthTotalDeposit = 0;
                            let monthTotalLoanInterest = 0;
                            let monthTotalInstallment = 0;
                            let monthTotalFine = 0;
                            
                            monthData.forEach(entry => {
                                monthTotalDeposit += entry.deposit;
                                monthTotalLoanInterest += entry.loanInterest;
                                monthTotalInstallment += entry.installment;
                                monthTotalFine += entry.fine;
                            });
                            
                            // Add to grand totals
                            grandTotalDeposit += monthTotalDeposit;
                            grandTotalLoanInterest += monthTotalLoanInterest;
                            grandTotalInstallment += monthTotalInstallment;
                            grandTotalFine += monthTotalFine;
                            grandTotalRecords += monthData.length;
                            
                            // Add to year totals
                            yearTotalDeposit += monthTotalDeposit;
                            yearTotalLoanInterest += monthTotalLoanInterest;
                            yearTotalInstallment += monthTotalInstallment;
                            yearTotalFine += monthTotalFine;
                            
                            // Month heading
                            htmlContent += `
                                <div class="month-heading">
                                    <h3>
                                        <span>üìÖ ${monthName}</span>
                                        <span class="record-count">${monthData.length} record${monthData.length > 1 ? 's' : ''}</span>
                                    </h3>
                                </div>
                            `;
                            
                            // Month total summary card
                            const monthGrandTotal = monthTotalDeposit + monthTotalLoanInterest + monthTotalInstallment + monthTotalFine;
                            htmlContent += `
                                <div class="month-total-summary">
                                    <h4>Month Totals</h4>
                                    <div class="month-total-grid">
                                        <div class="month-total-item">
                                            <div class="label">Deposit</div>
                                            <div class="value">Rs. ${monthTotalDeposit.toFixed(2)}</div>
                                        </div>
                                        <div class="month-total-item">
                                            <div class="label">Loan Interest</div>
                                            <div class="value">Rs. ${monthTotalLoanInterest.toFixed(2)}</div>
                                        </div>
                                        <div class="month-total-item">
                                            <div class="label">Installment</div>
                                            <div class="value">Rs. ${monthTotalInstallment.toFixed(2)}</div>
                                        </div>
                                        <div class="month-total-item">
                                            <div class="label">Fine</div>
                                            <div class="value">Rs. ${monthTotalFine.toFixed(2)}</div>
                                        </div>
                                        <div class="month-total-item">
                                            <div class="label">Grand Total</div>
                                            <div class="value">Rs. ${monthGrandTotal.toFixed(2)}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // Month table
                            htmlContent += `
                                <div style="overflow-x: auto;">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Member</th>
                                                <th>Deposit</th>
                                                <th>Loan Interest</th>
                                                <th>Installment</th>
                                                <th>Fine</th>
                                                <th>Total</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            monthData.forEach((entry, index) => {
                                const rowTotal = entry.deposit + entry.loanInterest + entry.installment + entry.fine;
                                htmlContent += `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td><strong>${entry.member}</strong></td>
                                        <td>Rs. ${entry.deposit.toFixed(2)}</td>
                                        <td>Rs. ${entry.loanInterest.toFixed(2)}</td>
                                        <td>Rs. ${entry.installment.toFixed(2)}</td>
                                        <td>Rs. ${entry.fine.toFixed(2)}</td>
                                        <td><strong>Rs. ${rowTotal.toFixed(2)}</strong></td>
                                        <td>
                                            <button class="delete-btn" onclick="confirmDelete('${entry.id}')">
                                                <span>üóëÔ∏è</span> Delete
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            // Month total row in table
                            htmlContent += `
                                <tr class="month-total">
                                    <td colspan="2"><strong>Month Total</strong></td>
                                    <td><strong>Rs. ${monthTotalDeposit.toFixed(2)}</strong></td>
                                    <td><strong>Rs. ${monthTotalLoanInterest.toFixed(2)}</strong></td>
                                    <td><strong>Rs. ${monthTotalInstallment.toFixed(2)}</strong></td>
                                    <td><strong>Rs. ${monthTotalFine.toFixed(2)}</strong></td>
                                    <td><strong>Rs. ${monthGrandTotal.toFixed(2)}</strong></td>
                                    <td></td>
                                </tr>
                            `;
                            
                            htmlContent += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        }
                    });
                    
                    // Year total summary
                    const yearGrandTotal = yearTotalDeposit + yearTotalLoanInterest + yearTotalInstallment + yearTotalFine;
                    htmlContent += `
                        <div class="month-total-summary" style="background: linear-gradient(135deg, #8e44ad, #6c3483);">
                            <h4>Year ${year} Totals</h4>
                            <div class="month-total-grid">
                                <div class="month-total-item">
                                    <div class="label">Deposit</div>
                                    <div class="value">Rs. ${yearTotalDeposit.toFixed(2)}</div>
                                </div>
                                <div class="month-total-item">
                                    <div class="label">Loan Interest</div>
                                    <div class="value">Rs. ${yearTotalLoanInterest.toFixed(2)}</div>
                                </div>
                                <div class="month-total-item">
                                    <div class="label">Installment</div>
                                    <div class="value">Rs. ${yearTotalInstallment.toFixed(2)}</div>
                                </div>
                                <div class="month-total-item">
                                    <div class="label">Fine</div>
                                    <div class="value">Rs. ${yearTotalFine.toFixed(2)}</div>
                                </div>
                                <div class="month-total-item">
                                    <div class="label">Grand Total</div>
                                    <div class="value">Rs. ${yearGrandTotal.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            // Calculate total loan amount
            let totalLoanAmount = 0;
            loanEntries.forEach(entry => {
                totalLoanAmount += entry.loanAmount;
            });
            
            // Calculate remaining amount
            const grandTotalAll = grandTotalDeposit + grandTotalLoanInterest + grandTotalInstallment + grandTotalFine;
            const remainingAmount = grandTotalAll - totalLoanAmount;
            
            // Grand Total Section with Remaining Amount
            htmlContent += `
                <div class="grand-total-section">
                    <h3>Grand Totals (All Years)</h3>
                    <div class="grand-total-grid">
                        <div class="total-card">
                            <div class="label">Total Records</div>
                            <div class="value">${grandTotalRecords}</div>
                        </div>
                        <div class="total-card">
                            <div class="label">Total Deposit</div>
                            <div class="value">Rs. ${grandTotalDeposit.toFixed(2)}</div>
                        </div>
                        <div class="total-card">
                            <div class="label">Total Loan Interest</div>
                            <div class="value">Rs. ${grandTotalLoanInterest.toFixed(2)}</div>
                        </div>
                        <div class="total-card">
                            <div class="label">Total Installment</div>
                            <div class="value">Rs. ${grandTotalInstallment.toFixed(2)}</div>
                        </div>
                        <div class="total-card">
                            <div class="label">Total Fine</div>
                            <div class="value">Rs. ${grandTotalFine.toFixed(2)}</div>
                        </div>
                        <div class="total-card">
                            <div class="label">Grand Total</div>
                            <div class="value">Rs. ${grandTotalAll.toFixed(2)}</div>
                        </div>
                        <div class="total-card loan-amount-card">
                            <div class="label">Total Loan Amount</div>
                            <div class="value">Rs. ${totalLoanAmount.toFixed(2)}</div>
                        </div>
                        <div class="total-card remaining-amount-card">
                            <div class="label">Remaining Amount</div>
                            <div class="value">Rs. ${remainingAmount.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            dataContainer.innerHTML = htmlContent;
        }

        // Display loan data
        function displayLoanData(loanEntries) {
            const loanDataContainer = document.getElementById('loanDataContainer');
            
            if (loanEntries.length === 0) {
                loanDataContainer.innerHTML = `
                    <h2 style="color: #8e44ad; margin-bottom: 20px; border-bottom: 2px solid #8e44ad; padding-bottom: 8px;">üí∞ Loan Records</h2>
                    <div class="empty-state">üì≠ No loan entries found.</div>
                `;
                return;
            }
            
            // Calculate total loan amount
            let totalLoanAmount = 0;
            loanEntries.forEach(entry => {
                totalLoanAmount += entry.loanAmount;
            });
            
            // Build loan table HTML
            let loanHTML = `
                <h2 style="color: #8e44ad; margin-bottom: 20px; border-bottom: 2px solid #8e44ad; padding-bottom: 8px;">üí∞ Loan Records</h2>
                <div style="overflow-x: auto;">
                    <table class="loan-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Year</th>
                                <th>Month</th>
                                <th>Member</th>
                                <th>Loan Amount</th>
                                <th>Loan Taken Date</th>
                                <th>Loan Maturity Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            loanEntries.forEach((entry, index) => {
                // Format Gregorian dates
                const takenDate = new Date(entry.loanTakenDate).toLocaleDateString('en-GB');
                const maturityDate = new Date(entry.loanMaturityDate).toLocaleDateString('en-GB');
                
                // Format Nepali dates if available
                let takenNepali = '';
                let maturityNepali = '';
                
                if (entry.loanTakenNepaliDate) {
                    const [y, m, d] = entry.loanTakenNepaliDate.split('-');
                    const nepaliMonths = [
                        'Baishakh', 'Jestha', 'Ashadh', 'Shrawan', 'Bhadra', 'Ashwin',
                        'Kartik', 'Mangsir', 'Poush', 'Magh', 'Falgun', 'Chaitra'
                    ];
                    takenNepali = `<div class="nepali-date">${nepaliMonths[parseInt(m)-1]} ${d}, ${y}</div>`;
                }
                
                if (entry.loanMaturityNepaliDate) {
                    const [y, m, d] = entry.loanMaturityNepaliDate.split('-');
                    const nepaliMonths = [
                        'Baishakh', 'Jestha', 'Ashadh', 'Shrawan', 'Bhadra', 'Ashwin',
                        'Kartik', 'Mangsir', 'Poush', 'Magh', 'Falgun', 'Chaitra'
                    ];
                    maturityNepali = `<div class="nepali-date">${nepaliMonths[parseInt(m)-1]} ${d}, ${y}</div>`;
                }
                
                loanHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${entry.year}</strong><div class="nepali-year-badge">‡§µ‡§ø.‡§∏‡§Ç. ${entry.year}</div></td>
                        <td><strong>${entry.month}</strong></td>
                        <td>${entry.member}</td>
                        <td><strong>Rs. ${entry.loanAmount.toFixed(2)}</strong></td>
                        <td>
                            ${takenNepali}
                            <div class="gregorian-date">${takenDate}</div>
                        </td>
                        <td>
                            ${maturityNepali}
                            <div class="gregorian-date">${maturityDate}</div>
                        </td>
                        <td>
                            <button class="delete-btn" onclick="confirmDelete('${entry.id}')">
                                <span>üóëÔ∏è</span> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            loanHTML += `
                        </tbody>
                    </table>
                </div>
                
                <div class="loan-total-section">
                    <h4>Loan Summary</h4>
                    <div class="loan-total-grid">
                        <div class="loan-total-item">
                            <div class="label">Total Loans</div>
                            <div class="value">${loanEntries.length}</div>
                        </div>
                        <div class="loan-total-item">
                            <div class="label">Total Loan Amount</div>
                            <div class="value">Rs. ${totalLoanAmount.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            loanDataContainer.innerHTML = loanHTML;
        }

        // Confirm delete - store the document ID and show password modal
        function confirmDelete(docId) {
            entryToDelete = docId;
            actionType = 'delete';
            showPasswordModal();
        }

        // Show password modal
        function showPasswordModal() {
            const modal = document.getElementById('passwordModal');
            const message = document.getElementById('passwordMessage');
            
            if (actionType === 'delete') {
                message.innerHTML = '‚ö†Ô∏è <strong>Delete Confirmation</strong><br>Enter password to delete this entry';
            } else if (actionType === 'show_form') {
                message.innerHTML = 'üîí <strong>Access Required</strong><br>Enter password to access the entry form';
            }
            
            modal.classList.add('active');
            document.getElementById('passwordInput').focus();
            document.getElementById('passwordInput').value = '';
        }

        // Close password modal
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
            entryToDelete = null;
            actionType = null;
        }

        // Verify password and perform action
        async function verifyPassword() {
            const password = document.getElementById('passwordInput').value;
            const passwordMessage = document.getElementById('passwordMessage');
            
            if (!password) {
                passwordMessage.innerHTML = '‚ö†Ô∏è <strong>Please enter a password</strong>';
                passwordMessage.style.color = '#e74c3c';
                return;
            }
            
            if (actionType === 'delete') {
                if (password === DELETE_PASSWORD) {
                    // Close modal FIRST
                    document.getElementById('passwordModal').classList.remove('active');
                    
                    // Store the ID locally before resetting
                    const docIdToDelete = entryToDelete;
                    
                    // Reset variables
                    entryToDelete = null;
                    actionType = null;
                    
                    // Now delete the entry
                    await deleteEntry(docIdToDelete);
                } else {
                    passwordMessage.innerHTML = '‚ùå <strong>Incorrect password!</strong><br>Default password is: admin123';
                    passwordMessage.style.color = '#e74c3c';
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                }
            } else if (actionType === 'show_form') {
                if (password === FORM_ACCESS_PASSWORD) {
                    // Close modal
                    document.getElementById('passwordModal').classList.remove('active');
                    
                    // Reset variables
                    entryToDelete = null;
                    actionType = null;
                    
                    // Show form
                    showFormSection();
                } else {
                    passwordMessage.innerHTML = '‚ùå <strong>Incorrect password!</strong><br>Default password is: admin123';
                    passwordMessage.style.color = '#e74c3c';
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                }
            }
        }

        // Delete entry function
        async function deleteEntry(docId) {
            if (!docId) {
                const statusDiv = document.getElementById('dataStatus');
                statusDiv.innerHTML = '<div class="status-message error">‚ùå Error: No document ID provided</div>';
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
                return;
            }
            
            try {
                await db.collection('memberMonthlyTracker').doc(docId).delete();
                
                // Refresh data
                await fetchData();
                
                // Show success message
                const statusDiv = document.getElementById('dataStatus');
                statusDiv.innerHTML = '<div class="status-message success">‚úÖ Entry deleted successfully!</div>';
                
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
                
            } catch (error) {
                console.error('Error deleting document: ', error);
                const statusDiv = document.getElementById('dataStatus');
                statusDiv.innerHTML = `<div class="status-message error">‚ùå Delete failed: ${error.message}</div>`;
                
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }
        }

        // Show Form Section
        function showFormSection() {
            document.getElementById('formSection').classList.add('active');
            document.getElementById('formHiddenSection').style.display = 'none';
        }

        // Hide Form Section
        function hideFormSection() {
            document.getElementById('formSection').classList.remove('active');
            document.getElementById('formHiddenSection').style.display = 'block';
        }

        // Show Password Modal for Form Access
        function showPasswordModalForForm() {
            actionType = 'show_form';
            showPasswordModal();
        }

        // Toggle Member Management Section
        function toggleMemberManagement() {
            const section = document.getElementById('memberManagementSection');
            if (section.style.display === 'block') {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
                displayMemberList();
            }
        }

        // Add new member function
        function addNewMember() {
            const newMemberInput = document.getElementById('newMemberName');
            const newMemberName = newMemberInput.value.trim();
            
            if (!newMemberName) {
                alert('Please enter a member name');
                return;
            }
            
            const memberSelect = document.getElementById('member');
            const loanMemberSelect = document.getElementById('loanMember');
            const filterMemberSelect = document.getElementById('filterMember');
            
            // Check if member already exists
            for (let i = 0; i < memberSelect.options.length; i++) {
                if (memberSelect.options[i].value === newMemberName) {
                    alert('Member already exists!');
                    return;
                }
            }
            
            // Add to dropdowns
            const newOption = document.createElement('option');
            newOption.value = newMemberName;
            newOption.textContent = newMemberName;
            memberSelect.appendChild(newOption);
            
            const newLoanOption = document.createElement('option');
            newLoanOption.value = newMemberName;
            newLoanOption.textContent = newMemberName;
            loanMemberSelect.appendChild(newLoanOption);
            
            const newFilterOption = document.createElement('option');
            newFilterOption.value = newMemberName;
            newFilterOption.textContent = newMemberName;
            filterMemberSelect.appendChild(newFilterOption);
            
            // Clear input
            newMemberInput.value = '';
            
            // Show success
            alert(`Member "${newMemberName}" added successfully!`);
            
            // Refresh member list display
            displayMemberList();
        }

        // Display member list
        function displayMemberList() {
            const memberListDiv = document.getElementById('memberList');
            const memberSelect = document.getElementById('member');
            
            let html = '';
            for (let i = 2; i < memberSelect.options.length; i++) { // Skip first two options (--Select-- and default)
                const memberName = memberSelect.options[i].value;
                html += `
                    <div class="member-item">
                        <span>${memberName}</span>
                        <button class="remove-member-btn" onclick="removeMember(${i}, '${memberName}')">Remove</button>
                    </div>
                `;
            }
            
            if (html === '') {
                html = '<div style="text-align: center; padding: 10px; color: #999;">No members added yet</div>';
            }
            
            memberListDiv.innerHTML = html;
        }

        // Remove member function
        function removeMember(index, memberName) {
            if (!confirm(`Are you sure you want to remove "${memberName}"?`)) {
                return;
            }
            
            const memberSelect = document.getElementById('member');
            const loanMemberSelect = document.getElementById('loanMember');
            const filterMemberSelect = document.getElementById('filterMember');
            
            // Remove from all dropdowns
            memberSelect.remove(index);
            
            for (let i = 0; i < loanMemberSelect.options.length; i++) {
                if (loanMemberSelect.options[i].value === memberName) {
                    loanMemberSelect.remove(i);
                    break;
                }
            }
            
            for (let i = 0; i < filterMemberSelect.options.length; i++) {
                if (filterMemberSelect.options[i].value === memberName) {
                    filterMemberSelect.remove(i);
                    break;
                }
            }
            
            // Refresh member list
            displayMemberList();
        }

        // Export to CSV function
        async function exportToCSV() {
            try {
                const snapshot = await db.collection('memberMonthlyTracker').get();
                
                if (snapshot.empty) {
                    alert('No data to export!');
                    return;
                }
                
                // Convert to array and sort
                const dataArray = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    dataArray.push({
                        ...data,
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date()
                    });
                });
                
                dataArray.sort((a, b) => b.timestamp - a.timestamp);
                
                let csvContent = 'text/csv;charset=utf-8,';
                csvContent += 'Type,Year,Month,Member,Deposit,Loan Interest,Installment,Fine,Loan Amount,Loan Taken Date,Loan Maturity Date,Total\n';
                
                dataArray.forEach(entry => {
                    if (entry.type === 'loan') {
                        csvContent += `"Loan","${entry.year}","${entry.month}","${entry.member}",,,,"${entry.loanAmount}","${entry.loanTakenDate}","${entry.loanMaturityDate}",${entry.loanAmount}\n`;
                    } else {
                        const total = entry.deposit + entry.loanInterest + entry.installment + entry.fine;
                        csvContent += `"Monthly","${entry.year}","${entry.month}","${entry.member}",${entry.deposit},${entry.loanInterest},${entry.installment},${entry.fine},,,${total}\n`;
                    }
                });
                
                // Create download link
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `member_tracker_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Data exported successfully!');
                
            } catch (error) {
                console.error('Error exporting data: ', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('passwordModal');
            if (event.target == modal) {
                closePasswordModal();
            }
        };
    </script>
</body>
</html>
